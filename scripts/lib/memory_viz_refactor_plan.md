# Scripts/Lib 重复代码重构计划

> **说明**: 基于代码重复分析发现的全局重复代码问题的解决方案  
> **进度追踪**: 请查看 [memory_viz_refactor_progress.md](./memory_viz_refactor_progress.md)  
> **分析报告**: 详见 [code_duplication_analysis.md](./code_duplication_analysis.md)

## 📋 当前重构方案

### 🎯 扩展重构 - 全局重复代码消除（阶段五）

**基于**: [代码重复分析报告](./code_duplication_analysis.md) 的发现

**重构范围**: `scripts/lib` 目录中的重复代码问题
**风险等级**: 中-高风险（涉及多个Shell脚本和Python文件）

#### 📊 重构步骤（按优先级排序）

**5.1** 统一项目根目录查找功能（🔴 最高优先级）

- **问题**: 4处重复实现
- **涉及文件**: `utils.py`, `common.sh`, 两个image处理脚本
- **策略**: 选择Shell或Python统一方案

**5.2** 标准化目录创建操作（🟡 中等优先级）

- **问题**: 9处重复实现
- **涉及文件**: Python visualizers + Shell脚本
- **策略**: 统一到工具函数或标准Shell命令

**5.3** 优化脚本目录获取方式（🟡 中等优先级）

- **问题**: 5+处类似实现，模式不统一
- **策略**: 标准化路径获取模式

**5.4** 最终决策：common/utils.py 处理（🟢 低优先级）

- **问题**: 完全未使用但提供有价值功能
- **选项**: 删除 vs 重构使用 vs 保持现状
- **依赖**: 基于前面步骤的重构结果

---

## 🎯 核心问题识别

### 🔴 最严重重复（优先解决）

**项目根目录查找功能** - 4处重复实现

- `common/utils.py:find_project_root()`
- `memory_viz/bin/common.sh:find_rcore_root()`
- `image/convert-png-to-webp.sh:find_root()`
- `image/convert-svg-to-svgo.sh:find_root()`

### 🟡 中等严重重复

**目录创建操作** - 9处重复实现

- Python: `utils.py:ensure_dir()`, `visualizers/` 中的直接调用
- Shell: 多个脚本中的 `mkdir -p` 命令

**脚本目录获取** - 5+处重复实现

- 不同的路径获取模式，缺乏统一标准

### 🟢 未使用代码问题

**common/utils.py** - 完全未被引用

- 提供有价值功能但无任何使用
- 需要决策：删除、重构使用、或保持现状

## 🔧 重构解决方案

### 🎯 方案一：Shell统一（推荐）

**理由**: Shell脚本是主要执行路径，`memory_viz/bin/common.sh` 已提供完善工具函数

| 重复问题            | 解决方案                                                              | 影响范围           |
|-----------------|-------------------------------------------------------------------|----------------|
| **项目根目录查找**     | 统一使用 `common.sh:find_rcore_root()`                                | 删除3处重复实现       |
| **目录创建**        | 标准化使用 `mkdir -p`                                                  | 清理Python中的重复调用 |
| **脚本目录获取**      | 统一使用 `SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"` | 标准化所有Shell脚本   |
| **utils.py 处理** | 删除（无任何引用）                                                         | 无影响            |

### 🔄 方案二：Python统一

**理由**: 如果未来要强化Python生态

| 重复问题          | 解决方案                         | 影响范围            |
|---------------|------------------------------|-----------------|
| **项目根目录查找**   | 重构所有Python文件使用 `utils.py`    | 需修改多个文件导入       |
| **目录创建**      | 统一使用 `utils.py:ensure_dir()` | 重构visualizers目录 |
| **Shell脚本重构** | 保持Shell实现，不与Python混合         | 维持双轨制           |

---

## ⚠️ 风险评估

| 风险等级    | 操作内容              | 影响范围            | 缓解措施        |
|---------|-------------------|-----------------|-------------|
| **中风险** | 删除3个Shell脚本中的重复函数 | 可能影响外部调用        | 逐个替换，保持接口一致 |
| **中风险** | 重构Python中的目录创建调用  | visualizers目录功能 | 按排除规则，谨慎处理  |
| **低风险** | 标准化脚本目录获取         | Shell脚本路径逻辑     | 统一模式，向后兼容   |
| **低风险** | 删除utils.py（如果选择）  | 无依赖关系           | 安全删除        |

---

## ✅ 验证策略

1. **功能验证**: 确保所有Shell脚本功能不变
2. **路径测试**: 验证项目根目录查找在各种环境下正常工作
3. **回滚准备**: 备份关键文件，确保可以快速恢复

## 🎯 推荐执行顺序

1. **5.1** 统一项目根目录查找（最高优先级，影响最大）
2. **5.2** 标准化目录创建操作
3. **5.3** 优化脚本目录获取方式
4. **5.4** 处理 utils.py（基于前面步骤结果决策）

---

> **进度跟踪**: [memory_viz_refactor_progress.md](./memory_viz_refactor_progress.md)  
> **分析报告**: [code_duplication_analysis.md](./code_duplication_analysis.md)  
> **历史**: Memory Viz重构（阶段一至四）已完成
